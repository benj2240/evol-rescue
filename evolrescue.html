<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Bird Evolution</title>
<style>
    #log {
        max-height: 24em;
        overflow-y: scroll;
    }

    footer {
        position: fixed;
        bottom: 0;
        padding: 0.2em;
        font-size: 0.8em;
    }
</style>
</head>
<body>
    <div id="log"></div>
    <!-- Enclosing the input in a form allows easy capturing of the enter key -->
    <form id="console">
        <input type="text" id="input" />
        <input type="submit" value="enter" />
    </form>
<script>
const LOG_ELEMENT = document.getElementById("log");
const FORM_ELEMENT = document.getElementById("console");
const INPUT_ELEMENT = document.getElementById("input");

// By default, form submits always refresh the page. We don't want that.
FORM_ELEMENT.addEventListener("submit", evt => evt.preventDefault());

/** Print the given message to the history
 */
function print (message) {
    const messageElement = document.createElement("div");
    messageElement.textContent = message;
    LOG_ELEMENT.appendChild(messageElement);
    messageElement.scrollIntoView();
}

/** Print the given message to the history, then wait for user input
 *  Returns a promise, which is resolved when the user submits their input
 */
function input (prompt) {
    print(prompt);
    return new Promise(function(resolve, reject) {
        const handleInput = function (evt) {
            FORM_ELEMENT.removeEventListener("submit", handleInput);
            value = INPUT_ELEMENT.value;
            INPUT_ELEMENT.value = "";
            resolve(value);
        };
        FORM_ELEMENT.addEventListener("submit", handleInput);
    });
}

function int (value) {
    return parseInt(value);
}

function str (value) {
    return value.toString();
}

const random = {
    choice: function (array) {
        const index = Math.floor(Math.random() * array.length);
        return array[index];
    }
}

function sum (array) {
    return array.reduce((a, b) => a + b, 0);
}

// environment colors
env = ["red", "orange", "yellow", "green", "blue", "purple"]
rounds = 6
score = 0

// counts of wild birds
nR = 0
nO = 0
nY = 0
nG = 0
nB = 0
nP = 0
total_wild = 0
wild_dict = {}

// counts of zoo birds
nZR = 5
nZO = 5
nZY = 5
nZG = 5
nZB = 5
nZP = 5
total_zoo = 30
zoo_dict = {}

opp_color = ""
adj_color = ""

function print_totals() {
    print("Your current wild bird population:")
    print("Red: " + str(wild_dict["red"]))
    print("Orange: " + str(wild_dict["orange"]))
    print("Yellow: " + str(wild_dict["yellow"]))
    print("Green: " + str(wild_dict["green"]))
    print("Blue: " + str(wild_dict["blue"]))
    print("Purple: " + str(wild_dict["purple"]) + "\n")
    total_zoo = sum(Object.values(zoo_dict))
    total_wild = sum(Object.values(wild_dict))
    total = total_zoo + total_wild
    print("Zoo: " + str(total_zoo))
    print("Wild: " + str(total_wild))
    print("Overall total: " +str(total) + "\n")
}

function color_match(current_env) {
    if (current_env == "red") {
        opp_color = "green"
        adj_color = ["purple", "orange"]
    } else if (current_env == "orange") {
        opp_color = "blue"
        adj_color = ["red", "yellow"]
    } else if (current_env == "yellow") {
        opp_color = "purple"
        adj_color = ["orange", "green"]
    } else if (current_env == "green") {
        opp_color = "red"
        adj_color = ["yellow", "blue"]
    } else if (current_env == "blue") {
        opp_color = "orange"
        adj_color = ["green", "purple"]
    } else if (current_env == "purple") {
        opp_color = "yellow"
        adj_color = ["blue", "red"]
    } else
        print("fail")
}

function predation(wild_dict, opp_color) {
    animal = ["hawk", "snake", "badger", "fox"]
    predator = random.choice(animal)
    print("\n" + "A " + str(predator) + " attacks!")
    if (wild_dict[opp_color]) {
        wild_dict[opp_color] = 0
        print("\n" + "Your " + str(opp_color) + " birds were very visible in the " + str(current_env) + " habitat and were all eaten.")
    }
    return(wild_dict)    
}

function reproduce(current_env, wild_dict, adj_color) {
    if (wild_dict[current_env]) {
        wild_dict[current_env] += 3
        print("You get +3 for your " + str(current_env) + " birds because they camouflage perfectly."+ "\n")
    }
    for (let i of adj_color) {
        if (wild_dict[i]) {
            wild_dict[i] += 1
            print("You get +1 for your " + str(adj_color) + " birds because they blend in pretty well." + "\n")
        }
    }
    return wild_dict
}
        
function mutation(wild_dict) {
    loser_choice = []
    winner_choice = ["red", "orange", "yellow", "green", "blue", "purple"]
    for (let [key, value] of Object.entries(wild_dict)) {
        if (value != 0)
            loser_choice.push(key)
    }
    loser = random.choice(loser_choice)
    wild_dict[loser] -= 1
    winner = random.choice(winner_choice)
    wild_dict[winner] += 1
    print("\n" + "One " + str(loser) + " bird mutated into a " + str(winner) + " bird." + "\n")
    return wild_dict
}

function drift(wild_dict) {
    t = 0
    option = ["A", "A", "B", "B", "C", "C", "D", "E"]
    loss = random.choice(option)
    if (loss == "A") {
        text = ["A poacher attacks! Lose 1 bird.", "Your birds get the flu. Lose 1 bird."]
        A = random.choice(text)
        print(str(A))
        loser_choice = []
        for (let [key, value] of Object.entries(wild_dict))
            if (value != 0)
                loser_choice.push(key)
        loser = random.choice(loser_choice)
        wild_dict[loser] -= 1
        print("You lost one " + str(loser) + " bird.")
    }
    else if (loss == "B") {
        text = ["A harsh winter takes its toll. Lose 2 birds.", "A drought limits food supply. Lose 2 birds."]
        B = random.choice(text)
        print(str(B))
        while (t < 2) {
            loser_choice = []
            for (let [key, value] of Object.entries(wild_dict))
                if (value != 0)
                    loser_choice.push(key)
            loser = random.choice(loser_choice)
            wild_dict[loser] -= 1
            print("You lost one " + str(loser) + " bird.")
            t += 1
        }
    }
    else if (loss == "C") {
        total = Math.round((sum(Object.values(wild_dict))/2))
        print("A fire destroys nesting locations. Half your birds die.")
        while (t < total) {
            loser_choice = []
            for (let [key, value] of Object.entries(wild_dict))
                if (value != 0)
                    loser_choice.push(key)
            loser = random.choice(loser_choice)
            wild_dict[loser] -= 1
            print(str(loser) + " lost one bird.")
            t += 1
        }
    }
    else
        print("\n" + "All your birds are safe!")    
    total_wild = sum(Object.values(wild_dict))
    print ("\n" + "You still have " + str(total_wild) + " wild birds" + "\n")    
    return wild_dict
}

async function migrate(wild_dict, zoo_dict) {
    if (zoo_dict["ZR"] > 0) {
        print("\n" + "Red in zoo: " + str(zoo_dict["ZR"]))
        nR = int(await input("Migrate how many red? "))
        while ((nZR - nR) < 0)
            nR = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZR) + ": "))
        wild_dict["red"] += nR
        zoo_dict["ZR"] = zoo_dict["ZR"] - nR
    }
    if (zoo_dict["ZO"] > 0) {
        print("\n" + "Orange in zoo: " + str(zoo_dict["ZO"]))
        nO = int(await input("Migrate how many orange? "))
        while ((nZO - nO) < 0)
            nO = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZO) + ": "))
        wild_dict["orange"] += nO
        zoo_dict["ZO"] = zoo_dict["ZO"] - nO
    }
    if (zoo_dict["ZY"] > 0) {
        print("\n" + "Yellow in zoo: " + str(zoo_dict["ZY"]))
        nY = int(await input("Migrate how many yellow? "))
        while ((nZY - nY) < 0)
            nY = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZY) + ": "))
        wild_dict["yellow"] += nY
        zoo_dict["ZY"] = zoo_dict["ZY"] - nY
    }
    if (zoo_dict["ZG"] > 0) {
        print("\n" + "Green in zoo: " + str(zoo_dict["ZG"]))
        nG = int(await input("Migrate how many green? "))
        while ((nZG - nG) < 0)
            nG = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZG) + ": "))
        wild_dict["green"] += nG
        zoo_dict["ZG"] = zoo_dict["ZG"] - nG
    }
    if (zoo_dict["ZB"] > 0) {
        print("\n" + "Blue in zoo: " + str(zoo_dict["ZB"]))
        nB = int(await input("Migrate how many blue? "))
        while ((nZB - nB) < 0)
            nB = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZB) + ": "))
        wild_dict["blue"] += nB
        zoo_dict["ZB"] = zoo_dict["ZB"] - nB
    }
    if (zoo_dict["ZP"] > 0) {
        print("\n" + "Purple in zoo: " + str(zoo_dict["ZP"]))
        nP = int(await input("Migrate how many purple? "))
        while ((nZP - nP) < 0)
            nP = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZP) + ": "))
        wild_dict["purple"] += nP
        zoo_dict["ZP"] = zoo_dict["ZP"] - nP
    }
    return wild_dict, zoo_dict
}

// ##############################################################################

async function play () {
round_no = 1
print("ROUND " + str(round_no) + "\n")
current_env = random.choice(env)
print("Current environment is: " + str(current_env) + "\n" )
print("Each zoo has 5 birds. You can take birds from the zoo and introduce them into the wild." + "\n")
nR = int(await input("How many red birds would you like to add from the zoo? " + "\n"))
while ((nZR - nR) < 0)
    nR = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZR) + ": "))
wild_dict["red"] = nR
zoo_dict["ZR"] = nZR - nR
    
nO = int(await input("How many orange birds would you like to add from the zoo? " + "\n"))
while ((nZO - nO) < 0)
    nO = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZO) + ": "))
wild_dict["orange"] = nO
zoo_dict["ZO"] = nZO - nO

nY = int(await input("How many yellow birds would you like to add from the zoo? " + "\n"))
while ((nZY - nY) < 0)
    nY = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZY) + ": "))
wild_dict["yellow"] = nY
zoo_dict["ZY"] = nZY - nY
    
nG = int(await input("How many green birds would you like to add from the zoo? " + "\n"))
while ((nZG - nG) < 0)
    nG = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZG) + ": "))
wild_dict["green"] = nG
zoo_dict["ZG"] = nZG - nG

nB = int(await input("How many blue birds would you like to add from the zoo? " + "\n"))
while ((nZB - nB) < 0)
    nB = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZB) + ": "))
wild_dict["blue"] = nB
zoo_dict["ZB"] = nZB - nB

nP = int(await input("How many purple birds would you like to add from the zoo? " + "\n"))
while ((nZP - nP) < 0)
    nP = int(await input("Invalid. Not enough birds in zoo. Please enter a number equal or less than " + str(nZP) + ": "))
wild_dict["purple"] = nP
zoo_dict["ZP"] = nZP - nP

while (round_no < rounds) {
    print("\n" + "---")
    color_match(current_env)
    await input("Press enter to encounter predators." + "\n")
    predation(wild_dict, opp_color)
    print("\n" + "---")
    await input("Press enter to reproduce." + "\n")
    reproduce(current_env, wild_dict, adj_color)
    print_totals()
    print("\n" + "---")
    await input("Press enter to mutate." + "\n")
    mutation(wild_dict)
    print_totals()
    print("\n" + "---")
    await input("Press enter to see the effects of drift (chance)." + "\n")
    drift(wild_dict)
    print_totals()
    print("\n" + "---")
    if (round_no < (rounds - 1)) {
        await input("Press enter to migrate." + "\n")
        choice_migrate = await input("\n" + "Do you want to add more birds from the zoo? ")
        if ((choice_migrate == "y" || choice_migrate == "yes")) {
            await migrate(wild_dict, zoo_dict)
            print_totals()
            print("\n" + "---" + "END OF ROUND " + str(round_no)+ "\n")            
        }
        else {
            print_totals()
            print("\n" + "---" + "END OF ROUND " + str(round_no) + "\n")
        }
        await input("Press enter for next round." + "\n")            
        print("\n" + "---" + "\n" + "ROUND" + str(round_no + 1) + "\n")
        current_env = random.choice(env)
        print("\n" + "Current environment is: " + str(current_env))
        round_no += 1
    }
    else
        round_no += 1
}
print("\n" + "The End!")  
print_totals()
score = (sum(Object.values(wild_dict)) + sum(Object.values(zoo_dict))) - 30
print("You were able to increase your bird population by " + str(score) + " birds.")
}

play();
</script>
<footer>
    <a href="https://github.com/benj2240/evol-rescue">How does this work?</a>
</footer>
</body>
</html>